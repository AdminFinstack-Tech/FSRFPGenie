# üîß How to Fix Search Results for Alert/Email/SMS Requirements

## üéØ Problem Identified

Your search query:
> "Any transaction happen in the system (financial or non-financial) alert should be generated by e-mail or SMS or both"

Is returning **irrelevant results** because:
1. ‚ùå The specific Excel file with this requirement **has NOT been uploaded/processed yet**
2. ‚ùå The vector database doesn't contain this requirement
3. ‚ùå Search is returning low-relevance fallback results (0.19-0.21 scores)

### What the System is Currently Finding:
- ‚ùå "The Bidders shall have legal capacity..." (about vendor eligibility)
- ‚ùå "Trade License/TIN/VAT certificate" (about business registration)
- ‚ùå Generic BRAC requirements (not related to alerts/notifications)

### What You NEED in the Database:
- ‚úÖ Row 24: "Any transaction happen in the system (financial or non-financial) alert should be generated by e-mail or SMS or both"
- ‚úÖ Function: General > Voucher/advice
- ‚úÖ Priority: Mandatory (M)

---

## üöÄ Solution: Upload Your Excel File

### Step 1: Locate Your Excel File

The requirement is in an Excel file with structure:
```
Column Headers:
- Item #: 24
- Function: General
- Sub-Function: Voucher/advice  
- Requirement: Any transaction happen in the system...
- Priority: M (Mandatory)
- Bidder Response: PC
- Bidder Justification: Need to configure
```

Find this file on your system (likely named something like):
- `Trade_Finance_Requirements.xlsx`
- `RFP_Requirements_BRAC.xlsx`
- `Annex_2_Detailed_Requirements.xlsx`
- Similar name with trade finance or RFP requirements

---

### Step 2: Upload via Web Interface

1. **Open the App**:
   ```
   http://localhost:8080
   ```

2. **Navigate to Upload Section**:
   - Click "Upload" or "Documents" in navigation
   - Or go directly to: http://localhost:8080/upload

3. **Select Processing Mode**:
   - Choose **"Professional Mode"** for full column mapping
   - Or **"Simple Mode"** for quick processing

4. **Upload Your Excel File**:
   - Drag & drop your Excel file
   - Or click "Browse" to select
   - Set **RFP Name**: "BRAC Trade Finance"
   - Set **Bank Name**: "BRAC"
   - Set **Document Type**: "RFP"

5. **Map Columns** (if Professional Mode):
   ```
   Map these columns:
   - Item # ‚Üí Item Number
   - Function ‚Üí Product/Module
   - Sub-Function ‚Üí Category
   - Requirement ‚Üí Requirement
   - Priority ‚Üí Priority
   - Bidder Response ‚Üí Response
   - Bidder Justification ‚Üí Comments
   ```

6. **Submit & Process**:
   - Click "Submit"
   - Wait for processing (may take 1-2 minutes)
   - Check status in Documents page

---

### Step 3: Verify Upload

After processing completes:

1. **Check Vector Embeddings**:
   ```bash
   cd /Users/ilyasashu/RFPAI && python3 << 'EOF'
   import pymongo
   
   client = pymongo.MongoClient('mongodb://localhost:27017/')
   db = client['rfp_system']
   
   # Search for alert/email/SMS
   results = db.vector_embeddings.find({
       '$or': [
           {'metadata.requirement': {'$regex': 'alert', '$options': 'i'}},
           {'metadata.requirement': {'$regex': 'email', '$options': 'i'}},
           {'metadata.requirement': {'$regex': 'SMS', '$options': 'i'}}
       ]
   }).limit(5)
   
   print("‚úÖ Found requirements:")
   for doc in results:
       print(f"   - {doc['metadata']['requirement'][:100]}...")
   EOF
   ```

2. **Test the Search**:
   - Go to Search page: http://localhost:8080/search
   - Select **"AI Intelligent"** mode
   - Query: **"alert notification email SMS transaction"**
   - Expected: Should now return relevant results with high scores (>0.7)

---

## üéØ Expected Results After Upload

### Before Upload (Current State):
```json
{
  "sources": [
    {
      "relevance_score": 0.21,
      "requirement": "The Bidders shall have legal capacity...",
      "product": "General"
    }
  ]
}
```
‚ùå **Wrong content, low relevance**

### After Upload (Expected):
```json
{
  "sources": [
    {
      "relevance_score": 0.85,
      "requirement": "Any transaction happen in the system (financial or non-financial) alert should be generated by e-mail or SMS or both",
      "product": "General",
      "sub_function": "Voucher/advice",
      "priority": "Mandatory",
      "sheet_name": "Requirements"
    }
  ],
  "answer": "Yes, the RFP requires alert generation for all transactions. Specifically, requirement #24 states that any transaction (financial or non-financial) must generate alerts via email, SMS, or both. This is a mandatory (M) requirement under the General > Voucher/advice function."
}
```
‚úÖ **Correct content, high relevance**

---

## üîç Alternative: Use Backend Upload API

If you prefer to upload programmatically:

```bash
curl -X POST http://localhost:5001/api/documents/upload \
  -F "file=@/path/to/your/excel_file.xlsx" \
  -F "rfp_name=BRAC Trade Finance" \
  -F "bank_name=BRAC" \
  -F "document_type=RFP" \
  -F "processing_mode=simple"
```

---

## üìä Verify Processing Status

Check processing status:

```bash
cd /Users/ilyasashu/RFPAI && python3 << 'EOF'
import pymongo

client = pymongo.MongoClient('mongodb://localhost:27017/')
db = client['rfp_system']

# Check documents
docs = db.documents.find().sort('uploaded_at', -1)

print("üìÅ Recent Documents:")
for doc in docs:
    print(f"\nüìÑ {doc.get('filename')}")
    print(f"   Status: {doc.get('status')}")
    print(f"   RFP: {doc.get('rfp_name')}")
    print(f"   Type: {doc.get('document_type')}")

# Check embeddings
count = db.vector_embeddings.count_documents({})
print(f"\nüìä Total Embeddings: {count}")
EOF
```

---

## üö® Troubleshooting

### Issue: File uploads but shows "awaiting_mapping"
**Solution**: 
- You're in Professional mode
- Go to Column Mapping page
- Map the columns
- Click "Process"

### Issue: Processing stuck
**Solution**:
```bash
# Check Celery logs
docker-compose logs backend | grep -i "processing\|error"

# Restart backend if needed
docker-compose restart backend
```

### Issue: Still no results after upload
**Solution**:
```bash
# Check if embeddings were created
cd /Users/ilyasashu/RFPAI && python3 << 'EOF'
import pymongo
client = pymongo.MongoClient('mongodb://localhost:27017/')
db = client['rfp_system']
count = db.vector_embeddings.count_documents({})
print(f"Total embeddings: {count}")

# If 0, check Azure OpenAI configuration
import os
print(f"Azure Key set: {bool(os.environ.get('AZURE_OPENAI_API_KEY'))}")
print(f"Azure Endpoint: {os.environ.get('AZURE_OPENAI_API_BASE')}")
EOF
```

### Issue: Azure OpenAI not configured
**Solution**:
```bash
# Edit docker-compose.yml or .env
# Add these environment variables:
AZURE_OPENAI_API_KEY=your_key_here
AZURE_OPENAI_API_BASE=your_endpoint_here
AZURE_OPENAI_DEPLOYMENT_NAME=gpt-4o
AZURE_OPENAI_EMBEDDING_DEPLOYMENT=text-embedding-3-large
USE_AZURE_EMBEDDINGS=true

# Restart services
docker-compose down
docker-compose up -d
```

---

## ‚úÖ Success Criteria

After uploading your Excel file, you should see:

1. ‚úÖ **File Status**: "completed" in Documents page
2. ‚úÖ **Vector Embeddings**: Count > 0 (should match number of rows)
3. ‚úÖ **Search Results**: High relevance scores (>0.7) for alert/email queries
4. ‚úÖ **AI Answer**: Accurate response mentioning requirement #24
5. ‚úÖ **Sheet Name**: Displayed in blue badge
6. ‚úÖ **Source Documents**: Show correct requirement text

---

## üìö Related Documentation

- **Upload Guide**: See `/frontend/src/views/Upload.vue`
- **Column Mapping**: See `/frontend/src/views/ColumnMapping.vue`
- **Search Guide**: See `/QUICK_START_GUIDE.md`
- **Enhanced Features**: See `/ENHANCED_SEARCH_GUIDE.md`

---

## üéì Understanding the Issue

### Why Search Returns Wrong Results:

**Vector Search Process**:
1. Your query: "alert email SMS transaction"
2. System converts to embedding vector (3072 dimensions)
3. Compares with ALL vectors in database
4. Returns closest matches by cosine similarity

**Current Problem**:
- Database has: Requirements about "vendors", "eligibility", "trade licenses"
- Database MISSING: Requirements about "alerts", "email", "SMS", "notifications"
- Result: Best match is weak (0.21 score) on generic words like "any", "or", "by"

**After Upload**:
- Database will have: "alert should be generated by e-mail or SMS"
- Your query will match directly
- Result: High score (>0.8) on exact requirement

---

## üéØ Summary

**To fix your search results:**

1. **Find** your Excel file with the alert/email/SMS requirement
2. **Upload** via http://localhost:8080/upload
3. **Process** with proper column mapping
4. **Verify** embeddings were created
5. **Search** again - should now return correct results!

**The search system is working correctly - it just needs the right data!** üéâ

---

*Last Updated: 2025-11-09*  
*Issue: Missing requirement data in vector database*  
*Solution: Upload Excel file with alert/notification requirements*
