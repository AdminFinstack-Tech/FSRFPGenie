# ðŸš¨ SEARCH ISSUE: Root Cause Analysis & Solution

## ðŸ“‹ Issue Summary

**User Query**: "Any transaction happen in the system alert should be generated by e-mail or SMS"

**Current Result**: Returns irrelevant results about vendor eligibility (relevance: 0.19-0.21)

**Expected Result**: Should return requirement about email/SMS alerts with high relevance (>0.8)

---

## ðŸ” Root Cause Analysis

### Diagnostic Results (2025-11-09):

```
âŒ Azure OpenAI: NOT CONFIGURED
   - API Key: Missing
   - Endpoint: Missing
   - Embeddings: Disabled

âŒ Database: EMPTY
   - Documents: 0
   - Vector Embeddings: 0
   - Alert requirements: 0
```

### Why Search Isn't Working:

1. **No Azure OpenAI Configuration**:
   - Cannot create embeddings for documents
   - Cannot generate AI answers
   - System cannot perform intelligent search

2. **No Documents Uploaded**:
   - Excel file with alert requirement not in database
   - No data to search through
   - No embeddings to compare

3. **JSON Response is from Previous Session**:
   - The sample response you provided was from when system had data
   - Current database is completely empty
   - Need to re-upload and re-process documents

---

## âœ… Solution: 3-Step Fix

### Step 1: Configure Azure OpenAI

**Option A: Using docker-compose.yml**

Edit `/Users/ilyasashu/RFPAI/docker-compose.yml`:

```yaml
services:
  backend:
    environment:
      # Add these Azure OpenAI variables
      - AZURE_OPENAI_API_KEY=your_api_key_here
      - AZURE_OPENAI_API_BASE=https://your-resource.openai.azure.com/
      - AZURE_OPENAI_API_VERSION=2024-02-01
      - AZURE_OPENAI_DEPLOYMENT_NAME=gpt-4o
      - AZURE_OPENAI_EMBEDDING_DEPLOYMENT=text-embedding-3-large
      - USE_AZURE_EMBEDDINGS=true
```

**Option B: Using .env file**

Create `/Users/ilyasashu/RFPAI/.env`:

```bash
AZURE_OPENAI_API_KEY=your_api_key_here
AZURE_OPENAI_API_BASE=https://your-resource.openai.azure.com/
AZURE_OPENAI_API_VERSION=2024-02-01
AZURE_OPENAI_DEPLOYMENT_NAME=gpt-4o
AZURE_OPENAI_EMBEDDING_DEPLOYMENT=text-embedding-3-large
USE_AZURE_EMBEDDINGS=true
```

Then restart:
```bash
docker-compose restart backend
```

**Get Azure OpenAI Credentials**:
1. Go to Azure Portal: https://portal.azure.com
2. Navigate to your Azure OpenAI resource
3. Copy:
   - API Key (Keys and Endpoint â†’ Key 1)
   - Endpoint (Keys and Endpoint â†’ Endpoint)
   - Deployment names (Model deployments page)

---

### Step 2: Upload Excel File

The Excel file should contain this requirement:

```
Item #: 24
Function: General
Sub-Function: Voucher/advice
Requirement: Any transaction happen in the system (financial or non-financial) 
             alert should be generated by e-mail or SMS or both
Priority: M (Mandatory)
```

**Upload Steps**:

1. **Open Upload Page**:
   ```
   http://localhost:8080/upload
   ```

2. **Fill Form**:
   - File: Select your Excel file (e.g., `Annex_2_Detailed_Requirements_Update2.xlsx`)
   - RFP Name: "BRAC Trade Finance"
   - Bank Name: "BRAC"
   - Document Type: "RFP"
   - Processing Mode: "Professional" (for column mapping) or "Simple" (auto-process)

3. **If Professional Mode** - Map Columns:
   ```
   Item # â†’ Item Number
   Function â†’ Product/Module
   Sub-Function â†’ Sub-Category
   Requirement â†’ Requirement
   Priority â†’ Priority
   Bidder Response â†’ Response
   Bidder Justification â†’ Comments
   ```

4. **Submit & Wait**:
   - Processing time: 1-3 minutes (depends on file size)
   - Check status in Documents page

5. **Verify Upload**:
   ```bash
   cd /Users/ilyasashu/RFPAI && python3 diagnose_search.py
   ```
   
   Should show:
   ```
   âœ… Documents: 1
   âœ… Vector Embeddings: 100+ (depends on rows)
   âœ… Alert requirements: 1+
   ```

---

### Step 3: Test Search

After upload completes:

1. **Go to Search Page**:
   ```
   http://localhost:8080/search
   ```

2. **Select AI Intelligent Mode**

3. **Enter Query**:
   ```
   email SMS alert notification transaction
   ```
   
   Or:
   ```
   How to generate alerts for transactions?
   ```

4. **Expected Results**:
   ```json
   {
     "answer": "Yes, the system requires alert generation for all transactions. 
                Requirement #24 specifies that any transaction (financial or 
                non-financial) must generate alerts via email, SMS, or both. 
                This is a mandatory requirement under General > Voucher/advice.",
     "sources": [
       {
         "relevance_score": 0.89,
         "requirement": "Any transaction happen in the system (financial or 
                        non-financial) alert should be generated by e-mail or 
                        SMS or both",
         "product": "General",
         "sub_function": "Voucher/advice",
         "priority": "Mandatory",
         "sheet_name": "Requirements",
         "file_name": "Annex_2_Detailed_Requirements_Update2.xlsx"
       }
     ],
     "confidence": 0.92
   }
   ```

---

## ðŸ”§ Troubleshooting

### Issue: "Azure OpenAI initialization failed"

**Check**:
```bash
docker-compose logs backend | grep -i "azure\|openai\|error"
```

**Solutions**:
- Verify API key is correct (no extra spaces)
- Check endpoint URL format: `https://YOUR-RESOURCE.openai.azure.com/`
- Ensure deployment names match your Azure setup
- Restart backend: `docker-compose restart backend`

---

### Issue: "Document processing stuck"

**Check Status**:
```bash
# Check document status
cd /Users/ilyasashu/RFPAI && python3 << 'EOF'
import pymongo
client = pymongo.MongoClient('mongodb://localhost:27017/')
db = client['rfp_system']
docs = db.documents.find()
for doc in docs:
    print(f"{doc['filename']}: {doc['status']}")
EOF
```

**Solutions**:
- If "awaiting_mapping": Go to Column Mapping page and complete mapping
- If "processing": Wait or check Celery logs: `docker-compose logs backend`
- If "error": Check error message in document metadata

---

### Issue: "Still getting wrong results after upload"

**Verify Embeddings Created**:
```bash
cd /Users/ilyasashu/RFPAI && python3 diagnose_search.py
```

Should show:
```
âœ… Vector Embeddings: 100+
âœ… Alert-related: 1+
```

**If embeddings = 0**:
1. Check Azure OpenAI is configured
2. Check document status is "completed"
3. Restart backend: `docker-compose restart backend`
4. Re-upload document

---

## ðŸ“Š System Architecture (For Understanding)

### How Intelligent Search Works:

```
User Query: "email SMS alert transaction"
     â†“
[1] Query â†’ Vector Embedding (3072 dimensions)
     â†“
[2] Compare with ALL document embeddings in MongoDB
     â†“
[3] Calculate cosine similarity scores
     â†“
[4] Return top N results (sorted by score)
     â†“
[5] GPT-4o generates natural language answer
     â†“
User sees: AI Answer + Source Documents
```

### Why Your Search Failed:

```
âŒ Current State:
   - Vector Embeddings: 0 documents
   - Query embedding: Created
   - Comparison: No documents to compare
   - Result: Empty or irrelevant fallback

âœ… After Fix:
   - Vector Embeddings: 100+ documents (including alert requirement)
   - Query embedding: Created
   - Comparison: Finds alert requirement with 0.89 similarity
   - Result: Relevant requirement returned with high score
```

---

## ðŸŽ¯ Quick Checklist

Before searching, ensure:

- [ ] Azure OpenAI API key configured
- [ ] Azure OpenAI endpoint configured
- [ ] Backend restarted after config changes
- [ ] Excel file uploaded
- [ ] Document status = "completed"
- [ ] Vector embeddings > 0
- [ ] Alert requirements found in database

Run diagnostic:
```bash
cd /Users/ilyasashu/RFPAI && python3 diagnose_search.py
```

All checks should be âœ… green.

---

## ðŸ“ž Getting Help

### Check Logs:

```bash
# Backend logs
docker-compose logs backend --tail=100

# All services
docker-compose logs --tail=50

# Follow live
docker-compose logs -f backend
```

### Check Container Status:

```bash
docker-compose ps
```

All services should show "Up".

### Restart Everything:

```bash
docker-compose down
docker-compose up -d
```

---

## ðŸ“š Related Documentation

- **Setup Guide**: `README_SETUP.md`
- **Search Features**: `ENHANCED_SEARCH_GUIDE.md`
- **Quick Start**: `QUICK_START_GUIDE.md`
- **Fix Search Results**: `HOW_TO_FIX_SEARCH_RESULTS.md`
- **Diagnostic Tool**: `diagnose_search.py`

---

## âœ… Success Verification

After completing all steps, run:

```bash
cd /Users/ilyasashu/RFPAI && python3 diagnose_search.py
```

Expected output:
```
================================================================================
ðŸ” RFP SEARCH SYSTEM DIAGNOSTIC REPORT
================================================================================

â˜ï¸  AZURE OPENAI CONFIGURATION
Status: âœ… Configured
API Key: âœ… Set
Endpoint: âœ… Set

ðŸ“ UPLOADED DOCUMENTS
Status: âœ… Documents found
Total Documents: 1+

ðŸ”¢ VECTOR EMBEDDINGS
Status: âœ… Embeddings exist
Total Embeddings: 100+
Alert-related: 1+

ðŸ”” ALERT/EMAIL/SMS REQUIREMENTS
Status: âœ… Found alert requirements
Found: 1+ requirements

ðŸ’¡ RECOMMENDATIONS
âœ… All systems operational!
   â†’ Documents uploaded
   â†’ Embeddings created
   â†’ Alert requirements indexed
   â†’ Search should work correctly
================================================================================
```

---

## ðŸŽ‰ Summary

**Problem**: Search returning irrelevant results  
**Root Cause**: Empty database + no Azure OpenAI configuration  
**Solution**: 
1. Configure Azure OpenAI
2. Upload Excel file with requirements
3. Verify embeddings created

**Time to Fix**: 10-15 minutes

**After Fix**: Search will return accurate results with high relevance scores (>0.8)

---

*Last Updated: 2025-11-09*  
*Status: Diagnostic Complete, Solution Provided*  
*Next Step: Configure Azure OpenAI and upload documents*
